var q=Object.defineProperty;var z=(r,e,n)=>e in r?q(r,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):r[e]=n;var D=(r,e,n)=>(z(r,typeof e!="symbol"?e+"":e,n),n);import{s as H,n as x,r as K,o as N,b as G}from"../chunks/scheduler.b8ee1aee.js";import{S as O,i as X,g as k,h as v,j as Q,f as _,l as y,k as U,a as V,x as P,B as b,t as T,b as L,d as I,p as j,r as F,u as J,v as Z,w as $}from"../chunks/index.b64d0558.js";import{P as ee}from"../chunks/Tileset.25979cb8.js";import{T as te}from"../chunks/Tilemap.cf4854d6.js";function ne(r){let e,n,t,a,l;return{c(){e=k("div"),n=k("div"),t=k("canvas"),this.h()},l(c){e=v(c,"DIV",{style:!0});var h=Q(e);n=v(h,"DIV",{class:!0});var s=Q(n);t=v(s,"CANVAS",{style:!0,tabindex:!0}),Q(t).forEach(_),s.forEach(_),h.forEach(_),this.h()},h(){y(t,"position","absolute"),U(t,"tabindex","1"),U(n,"class","canvas svelte-16cu0gi"),y(e,"display","flex"),y(e,"flex-direction","column"),y(e,"flex-grow","1")},m(c,h){V(c,e,h),P(e,n),P(n,t),r[4](t),a||(l=[b(t,"wheel",r[1]),b(t,"pointerdown",oe),b(t,"pointerup",ae),b(t,"pointercancel",re),b(t,"pointermove",ie),b(t,"keydown",r[2])],a=!0)},p:x,i:x,o:x,d(c){c&&_(e),r[4](null),a=!1,K(l)}}}function oe(r){}function ae(r){}function re(r){}function ie(r){}function se(r,e,n){let{engine:t}=e,a;function l(){var B,C;if(!a){requestAnimationFrame(l);return}const o=a.getContext("2d");if(!o){requestAnimationFrame(l);return}const i=(((B=a.parentElement)==null?void 0:B.scrollWidth)||0)-4,d=(((C=a.parentElement)==null?void 0:C.scrollHeight)||0)-4;n(0,a.width=i,a),n(0,a.height=d,a),o.imageSmoothingEnabled=!1,o.resetTransform(),o.clearRect(0,0,i,d);const{camera:p,tilemap:u}=t;if(!u.tileset){requestAnimationFrame(l);return}const[m,A]=[u.tileset.tilewidth,u.tileset.tileheight];for(let f of t.characters)p&&f.name==="Player"&&(p.centerX=f.position.x*m,p.centerY=f.position.y*A);o.setTransform(p.zoom,0,0,p.zoom,i/2-p.centerX*p.zoom,d/2-p.centerY*p.zoom);for(let f of u.layers){if(!f.visible)continue;const g=Object.entries(f.tiles).sort((w,Y)=>{const[R,M]=w[0].split(",").map(E=>parseInt(E)),[S,W]=Y[0].split(",").map(E=>parseInt(E));return M===W?R-S:M-W});for(let[w,Y]of g){const[R,M]=w.split(",").map(S=>parseInt(S));u.tileset.drawTile(o,R,M,Y.tileX,Y.tileY)}}for(let f of t.characters)if(typeof f.token=="string")ee.fromDataURL(f.token).bitmap().then(g=>{f.token=g});else if(f.token instanceof ImageBitmap){const[g,w]=[f.position.x*m,f.position.y*A];o.drawImage(f.token,g,w,m,A),o.fillStyle="red",o.fillRect(g,w-1,u.tileset.tilewidth*(f.health.current/f.health.max),1)}requestAnimationFrame(l)}function c(o){const{camera:i}=t;o.deltaY<0?i.zoom*=1.1:o.deltaY>0&&(i.zoom*=.9),i.zoom=Math.min(Math.max(.25,i.zoom),8)}function h(o){const i=t.characters.find(u=>u.name==="Player");if(!i)return;const{x:d,y:p}=i.position;switch(!0){case o.key==="ArrowLeft":i.position.x--,o.preventDefault();break;case o.key==="ArrowRight":i.position.x++,o.preventDefault();break;case o.key==="ArrowUp":i.position.y--,o.preventDefault();break;case o.key==="ArrowDown":i.position.y++,o.preventDefault();break}for(let u=0;u<t.characters.length;u++){const m=t.characters[u],A=Math.round(Math.sqrt(Math.pow(m.position.x-i.position.x,2)+Math.pow(m.position.y-i.position.y,2)));m.name!=="Player"&&A===0&&(i.position.x=d,i.position.y=p,m.health.current-=Math.ceil(Math.random()*3),m.health.current<=0&&t.characters.splice(u,1))}}N(()=>{requestAnimationFrame(l)});function s(o){G[o?"unshift":"push"](()=>{a=o,n(0,a)})}return r.$$set=o=>{"engine"in o&&n(3,t=o.engine)},[a,c,h,t,s]}class le extends O{constructor(e){super(),X(this,e,se,ne,H,{engine:3})}}class ce{constructor(e,n){D(this,"camera");D(this,"tilemap");D(this,"characters",[]);this.camera=e,this.tilemap=n}addCharacter(e){this.characters.push(e)}}function fe(r){let e,n,t;return{c(){e=k("input"),this.h()},l(a){e=v(a,"INPUT",{type:!0,accept:!0}),this.h()},h(){U(e,"type","file"),U(e,"accept","image/png")},m(a,l){V(a,e,l),n||(t=b(e,"change",r[1]),n=!0)},p:x,i:x,o:x,d(a){a&&_(e),n=!1,t()}}}function ue(r){let e,n;return e=new le({props:{engine:r[0]}}),{c(){F(e.$$.fragment)},l(t){J(e.$$.fragment,t)},m(t,a){Z(e,t,a),n=!0},p(t,a){const l={};a&1&&(l.engine=t[0]),e.$set(l)},i(t){n||(I(e.$$.fragment,t),n=!0)},o(t){T(e.$$.fragment,t),n=!1},d(t){$(e,t)}}}function pe(r){let e,n,t,a;const l=[ue,fe],c=[];function h(s,o){return s[0]?0:1}return n=h(r),t=c[n]=l[n](r),{c(){e=k("div"),t.c(),this.h()},l(s){e=v(s,"DIV",{style:!0});var o=Q(e);t.l(o),o.forEach(_),this.h()},h(){y(e,"display","flex"),y(e,"gap","16px"),y(e,"justify-content","space-between"),y(e,"width","100%")},m(s,o){V(s,e,o),c[n].m(e,null),a=!0},p(s,[o]){let i=n;n=h(s),n===i?c[n].p(s,o):(j(),T(c[i],1,1,()=>{c[i]=null}),L(),t=c[n],t?t.p(s,o):(t=c[n]=l[n](s),t.c()),I(t,1),t.m(e,null))},i(s){a||(I(t),a=!0)},o(s){T(t),a=!1},d(s){s&&_(e),c[n].d()}}}function he(r,e,n){let t;function a(l){if(l.target===null)return;const c=l.target.files;if(c===null)return;const h=c[0];te.loadFromFile(h).then(s=>{n(0,t=new ce({centerX:0,centerY:0,zoom:1},s));const o=[];if(!s.tileset)return;for(let p of s.layers)for(let u of Object.entries(p.tiles)){const[m,A]=u;if(s.tileset.getTileData(A.tileX,A.tileY,"tags",[]).includes("path")){const[C,f]=m.split(",").map(g=>parseInt(g));o.push([C,f])}}const i=o[Math.floor(Math.random()*o.length)];t.addCharacter({name:"Player",token:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABqklEQVQY06WRMUhbURSGv0h8kBKetppGBRErWaoQqEWMtIttdBCUgpQM9k51ELfQyUUcyltEdIiLnZ4WOnTQgkNLDbhUiGAQmqE8aHTQ6yNFQYKKBq5LiYnviRHPdC/nP9/9/3OJxyLKMAwVj0UUgGEYijuUNxAeRAiBaYIRHlRCCAClZ+Yc4vGlA48DACClRAiBlBIpJQDtjV4HIDHSoK5DiirTNAGIRqMAhIamyoatlUn3CLntb2RONslZkpkvGx5AiZeP+fl9ldf9AwAkZz8CGjoai8NP1Hp3rdMBQDwWUXpmDuvQSwtgraT+dzTaHlYXdce9fgDSyTxVpYBXLzrxt/YU76GhqbIoudMCudMC+9lDdwcA9cEmdu0uWs5SJbm1G7+xintWmYN/9j5vJz6ztpwgz1UUsvOVOah72sPacsIhWu+uJT0WJPXGR9/Cb3cH4VAjhT+/3J/xXx1/jHbQBQR8NvrRRXmE85pmHjQ0OwF7O7fvYNuSHD/fIaidu8i0ypZYWnbWOdTU+oiAz64MAPDpw5YH4P30M5VO5gHQjy6K/Xdf/3ouAbr/hlXyQ9uGAAAAAElFTkSuQmCC",position:{x:i[0],y:i[1]},health:{max:20,current:20},items:[{name:"Short Sword",damage:"1d6",skills:["Melee weapons"]}],controlled_by:"current_player"});const d=o[Math.floor(Math.random()*o.length)];t.addCharacter({name:"Orc",token:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABTElEQVQY06WRsUvDYBDFfylx0cEIDbZC69K6xlVBCYKbDsWlUzcXcShuXRwcDHTopP+BQxwEsWNQMrWCQcwgqN0qWOTrUBcFlzhoY9okgu2b7r579+7ddwAYhuExImTDMLxSqQTgVSoVCWBxfzNS8O6gLg2/SY7j+GTLsjj9aKBk1chpvbYIiSQsy/Kb+w7+g0RcodcWkXHoD4R7wf37DaLVQdd1r/dTCK4RjHVd91e2bVuSg2q5XA7hCt6yYG4cYu0uA7B+1KBaLnyTUr98G5CHLamqCnWBM3XCzNYOANVyAS2fDtnfKy55CcbEgAMhBKZpcnl+HElOzs75cff1JXyF7eJKbHOsg6uFJLdZBeYVVh8b463wOZ1hMpUJsx7O4gXWnrpo3gRuq8M1oOWfR3cQhNvqhHJtKK+ZTUn+S71mNqX+vbV8ekC0X/sCfEF0/rAYTgQAAAAASUVORK5CYII=",position:{x:d[0],y:d[1]},health:{max:20,current:20},items:[{name:"Hand axe",damage:"1d4",skills:["Melee weapons"]},{name:"Leather pouch",contents:[{name:"Copper Pieces",amount:5},{name:"Silver Pieces",amount:1}]}],controlled_by:"ai"})})}return[t,a]}class be extends O{constructor(e){super(),X(this,e,he,pe,H,{})}}export{be as component};
